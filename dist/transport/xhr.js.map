{"version":3,"sources":["transport/xhr.js"],"names":["global","XHR","provide","Weakmap","Pledge","isObject","iterate","Url","functionMerge","XDR","XDomainRequest","storage","flatten","object","prefix","items","value","i","Array","isArray","key","checkState","this","readyState","abort","request","method","pointer","properties","get","isString","data","settings","url","xhr","local","deferred","defer","boundCheckState","bind","timeout","parameter","set","cache","Date","search","substr","serialize","xhrOptions","property","ontimeout","onerror","onabort","reject","onprogress","onreadystatechange","clearTimeout","setTimeout","onload","status","resolve","responseText","open","href","setRequestHeader","accept","contentType","header","send","pledge","TransportXhr","prototype","call","post","put","patch","delete","head","async","username","password","x-requested-with","XMLHttpRequest"],"mappings":"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","file":"xhr.js","sourcesContent":["/**\n * @use /demand/weakmap\n * @use /demand/pledge\n * @use /demand/validator/isObject\n * @use /demand/function/iterate\n *\n * @require ../url\n * @require ../function/merge\n */\n\n(function(global, XHR) {\n\t'use strict';\n\n\tfunction definition(Weakmap, Pledge, isObject, iterate, Url, functionMerge) {\n\t\tvar XDR     = 'XDomainRequest' in global &&  global.XDomainRequest || XHR,\n\t\t\tstorage = new Weakmap();\n\n\t\tfunction flatten(object, prefix, items) {\n\t\t\tvar i = 0, value;\n\n\t\t\tprefix = prefix || '';\n\t\t\titems  = items || {};\n\n\t\t\tif(Array.isArray(object)) {\n\t\t\t\tfor(i = 0; typeof (value = object[i]) !== 'undefined'; i++) {\n\t\t\t\t\tflatten(value, prefix + '[' + i + ']', items);\n\t\t\t\t}\n\t\t\t} else if(isObject(object)) {\n\t\t\t\titerate(object, function(key, value) {\n\t\t\t\t\tflatten(value, prefix ? prefix + '[' + key + ']' : key, items);\n\t\t\t\t});\n\t\t\t} else if(prefix && typeof object !== 'undefined') {\n\t\t\t\titems[prefix] = object;\n\t\t\t}\n\n\t\t\treturn items;\n\t\t}\n\n\t\tfunction serialize(data) {\n\t\t\tvar url = new Url('/');\n\n\t\t\titerate(data, url.parameter.set, url);\n\n\t\t\treturn url.search.substr(1);\n\t\t}\n\n\t\tfunction checkState() {\n\t\t\tif(this.readyState < 4) {\n\t\t\t\tthis.abort();\n\t\t\t}\n\t\t}\n\n\t\tfunction request(method) {\n\t\t\tvar properties      = storage.get(this),\n\t\t\t\tisString        = typeof properties.data === 'string',\n\t\t\t\tsettings        = properties.settings,\n\t\t\t\turl             = properties.url,\n\t\t\t\tdata            = isString ? properties.data : flatten(properties.data),\n\t\t\t\txhr             = url.local ? new XHR() : new XDR(),\n\t\t\t\tdeferred        = Pledge.defer(),\n\t\t\t\tboundCheckState = checkState.bind(xhr),\n\t\t\t\ttimeout         = settings.timeout,\n\t\t\t\tpointer;\n\n\t\t\tif(data && method === 'GET') {\n\t\t\t\tif(isString) {\n\t\t\t\t\turl.parameter = data;\n\t\t\t\t} else {\n\t\t\t\t\titerate(data, url.parameter.set, url);\n\t\t\t\t}\n\n\t\t\t\tdata = null;\n\t\t\t}\n\n\t\t\tif(!settings.cache) {\n\t\t\t\turl.parameter.set('nucleus', +new Date());\n\t\t\t}\n\n\t\t\tif(data && !isString) {\n\t\t\t\tdata = serialize(data);\n\t\t\t}\n\n\t\t\tif(isObject(settings.xhrOptions)) {\n\t\t\t\titerate(settings.xhrOptions, function(property, value) {\n\t\t\t\t\txhr[property] = value;\n\t\t\t\t});\n\t\t\t}\n\n\t\t\txhr.ontimeout  = xhr.onerror = xhr.onabort = function() {\n\t\t\t\tdeferred.reject(xhr);\n\t\t\t};\n\t\t\txhr.onprogress = xhr.onreadystatechange = function() {\n\t\t\t\tclearTimeout(pointer);\n\n\t\t\t\tpointer = setTimeout(boundCheckState, timeout);\n\t\t\t};\n\t\t\txhr.onload     = function() {\n\t\t\t\tpointer = clearTimeout(pointer);\n\n\t\t\t\tif(!('status' in xhr) || xhr.status === 200) {\n\t\t\t\t\tdeferred.resolve(xhr.responseText, xhr);\n\t\t\t\t} else {\n\t\t\t\t\tdeferred.reject(xhr);\n\t\t\t\t}\n\t\t\t};\n\n\t\t\txhr.open(method, url.href, true);\n\n\t\t\tif(xhr.setRequestHeader) {\n\t\t\t\txhr.setRequestHeader('Accept', settings.accept);\n\n\t\t\t\tif(data && method !== 'GET') {\n\t\t\t\t\txhr.setRequestHeader('Content-Type', settings.contentType);\n\t\t\t\t}\n\n\t\t\t\tif(isObject(settings.header)) {\n\t\t\t\t\titerate(settings.header, function(header, value) {\n\t\t\t\t\t\txhr.setRequestHeader(header, value);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\n\t\t\txhr.send(data);\n\n\t\t\tpointer = setTimeout(boundCheckState, timeout);\n\n\t\t\treturn deferred.pledge;\n\t\t}\n\n\t\tfunction TransportXhr(url, data, settings) {\n\t\t\tstorage.set(this, {\n\t\t\t\tsettings: functionMerge({}, TransportXhr.settings, settings),\n\t\t\t\turl:      new Url(url),\n\t\t\t\tdata:     data\n\t\t\t});\n\n\t\t\treturn this;\n\t\t}\n\n\t\tTransportXhr.prototype = {\n\t\t\tget:      function() {\n\t\t\t\treturn request.call(this, 'GET');\n\t\t\t},\n\t\t\tpost:     function() {\n\t\t\t\treturn request.call(this, 'POST');\n\t\t\t},\n\t\t\tput:      function() {\n\t\t\t\treturn request.call(this, 'PUT');\n\t\t\t},\n\t\t\tpatch:      function() {\n\t\t\t\treturn request.call(this, 'PATCH');\n\t\t\t},\n\t\t\t'delete': function() {\n\t\t\t\treturn request.call(this, 'DELETE');\n\t\t\t},\n\t\t\thead:     function() {\n\t\t\t\treturn request.call(this, 'HEAD');\n\t\t\t}\n\t\t};\n\n\t\tTransportXhr.settings = {\n\t\t\taccept:      '*/*',\n\t\t\ttimeout:     8000,\n\t\t\tasync:       true,\n\t\t\tcache:       false,\n\t\t\tusername:    null,\n\t\t\tpassword:    null,\n\t\t\tcontentType: 'application/x-www-form-urlencoded; charset=UTF-8',\n\t\t\theader:      { 'x-requested-with': 'XMLHttpRequest' },\n\t\t\txhrOptions:  {}\n\t\t};\n\n\t\treturn TransportXhr;\n\t}\n\n\tprovide([ '/demand/weakmap', '/demand/pledge', '/demand/validator/isObject', '/demand/function/iterate', '../url', '../function/merge' ], definition);\n}(this, XMLHttpRequest));\n"]}