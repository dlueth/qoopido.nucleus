{"version":3,"sources":["task.js"],"names":["global","definition","abstractUuid","Pledge","isInstanceOf","defer","supportMethod","processQueue","task","thread","queue","length","supported","threads","idle","shift","busy","uuid","addEventListener","onMessage","onError","postMessage","load","toString","parameter","ArrayBuffer","deferred","resolve","apply","exception","reject","disposeTask","removeEventListener","push","Task","self","call","this","pledge","worker","NativeWorker","NativeUrl","NativeBlob","source","i","prototype","event","data","type","result","createObjectURL","extends","provide"],"mappings":"CASC,SAASA,GACT,YAEA,SAASC,GAAWC,EAAcC,EAAQC,EAAcC,EAAOC,GAW9D,QAASC,KACR,GAAIC,GAAMC,GAEPC,EAAMC,QAAYC,IAAaC,EAAQC,KAAKH,SAC9CH,EAAOE,EAAMK,QAEVH,GACFH,EAASI,EAAQC,KAAKC,QAEtBF,EAAQG,KAAKR,EAAKS,MAAQR,EAE1BA,EAAOS,iBAAiB,UAAWV,EAAKW,WACxCV,EAAOS,iBAAiB,QAASV,EAAKY,SACtCX,EAAOY,aAAcC,KAAMd,EAAKc,KAAKC,WAAYC,UAAWhB,EAAKgB,WAAaC,GAAerB,EAAaI,EAAKgB,UAAWC,IAAiBjB,EAAKgB,WAAc,OAE9JnB,EAAM,WACL,IACCG,EAAKkB,SAASC,QAAQnB,EAAKc,KAAKM,MAAM,KAAMpB,EAAKgB,YAChD,MAAMK,GACPrB,EAAKkB,SAASI,SAGfvB,OAMJ,QAASwB,GAAYvB,GACpB,GAAIC,GAASI,EAAQG,KAAKR,EAAKS,YAExBJ,GAAQG,KAAKR,EAAKS,MAEzBR,EAAOuB,oBAAoB,UAAWxB,EAAKW,WAC3CV,EAAOuB,oBAAoB,QAASxB,EAAKY,SACzCP,EAAQC,KAAKmB,KAAKxB,GAClBF,IAGD,QAAS2B,GAAKZ,EAAME,GACnB,GAAIW,GAAWjC,EAAakC,KAAKC,MAChCX,EAAWvB,EAAOE,OASnB,OAPA8B,GAAKT,SAAYA,EACjBS,EAAKb,KAAYA,EACjBa,EAAKX,UAAYA,MAEjBd,EAAMuB,KAAKE,GACX5B,IAEOmB,EAASY,OA5DjB,GAQCC,GARGd,EAAe,eAAiBzB,GAASyB,EAAc,KAC1De,EAAelC,EAAc,UAC7BmC,EAAenC,EAAc,OAC7BoC,EAAepC,EAAc,QAC7BM,EAAe4B,GAAgBC,GAAaC,EAC5CC,EAAe,4ZACf9B,GAAiBC,QAAUE,SAC3BN,KACQkC,EAAI,CA6Eb,IAtBAV,EAAKW,WAMJ1B,UAAW,SAAS2B,GACnB,GAAIX,GAAOE,IAEY,YAApBS,EAAMC,KAAKC,OACbb,EAAKT,SAASC,QAAQmB,EAAMC,KAAKE,QACjClB,EAAYI,KAGdf,QAAS,WACR,GAAIe,GAAOE,IAEXF,GAAKT,SAASI,SACdC,EAAYI,KAIXvB,EACF,IAGC,IAFA2B,EAASE,EAAUS,gBAAgB,GAAIR,IAAaC,IAAYK,KAAM,4BAEhEJ,EAAI,EAAGA,IACZ/B,EAAQC,KAAK8B,GAAK,GAAIJ,GAAaD,GAEnC,MAAMV,GACPjB,GAAY,EAId,MAAOsB,GAAKiB,QAAQjD,GAGrBkD,SAAU,wBAAyB,iBAAkB,iCAAkC,yBAA0B,oBAAqBnD,IACrIoC","file":"task.js","sourcesContent":["/**\n * @use /demand/abstract/uuid\n * @use /demand/pledge\n * @use /demand/validator/isInstanceOf\n * @use /demand/function/defer\n *\n * @require ./support/method\n */\n\n(function(global) {\n\t'use strict';\n\n\tfunction definition(abstractUuid, Pledge, isInstanceOf, defer, supportMethod) {\n\t\tvar ArrayBuffer  = 'ArrayBuffer' in global ? ArrayBuffer : null,\n\t\t\tNativeWorker = supportMethod('Worker'),\n\t\t\tNativeUrl    = supportMethod('URL'),\n\t\t\tNativeBlob   = supportMethod('Blob'),\n\t\t\tsupported    = NativeWorker && NativeUrl && NativeBlob,\n\t\t\tsource       = 'function d(a){return a.replace(c,\"\").trim()}function e(a){return a}var a=this,b=/function\\s.*?\\(([^)]*)\\)/,c=/\\/\\*.*\\*\\//;a.addEventListener(\"message\",function(b){a.postMessage({type:\"result\",result:a.process(b.data.load).apply(null,b.data.parameter)})},!1),a.process=function(a){var c=a.match(b)[1].split(\",\").map(d).filter(e);return c.push(a.substring(a.indexOf(\"{\")+1,a.lastIndexOf(\"}\"))),Function.apply(null,c)};',\n\t\t\tthreads      = { idle: [], busy: {} },\n\t\t\tqueue        = [],\n\t\t\tworker, i = 0;\n\n\t\tfunction processQueue() {\n\t\t\tvar task, thread;\n\n\t\t\tif(queue.length && (!supported || threads.idle.length)) {\n\t\t\t\ttask = queue.shift();\n\n\t\t\t\tif(supported) {\n\t\t\t\t\tthread = threads.idle.shift();\n\n\t\t\t\t\tthreads.busy[task.uuid] = thread;\n\n\t\t\t\t\tthread.addEventListener('message', task.onMessage);\n\t\t\t\t\tthread.addEventListener('error', task.onError);\n\t\t\t\t\tthread.postMessage({ load: task.load.toString(), parameter: task.parameter }, ArrayBuffer && isInstanceOf(task.parameter, ArrayBuffer) ? [ task.parameter ] : null);\n\t\t\t\t} else {\n\t\t\t\t\tdefer(function(){\n\t\t\t\t\t\ttry {\n\t\t\t\t\t\t\ttask.deferred.resolve(task.load.apply(null, task.parameter));\n\t\t\t\t\t\t} catch(exception) {\n\t\t\t\t\t\t\ttask.deferred.reject();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tprocessQueue();\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\n\t\tfunction disposeTask(task) {\n\t\t\tvar thread = threads.busy[task.uuid];\n\n\t\t\tdelete threads.busy[task.uuid];\n\n\t\t\tthread.removeEventListener('message', task.onMessage);\n\t\t\tthread.removeEventListener('error', task.onError);\n\t\t\tthreads.idle.push(thread);\n\t\t\tprocessQueue();\n\t\t}\n\n\t\tfunction Task(load, parameter) {\n\t\t\tvar self     = abstractUuid.call(this),\n\t\t\t\tdeferred = Pledge.defer();\n\n\t\t\tself.deferred  = deferred;\n\t\t\tself.load      = load;\n\t\t\tself.parameter = parameter || [];\n\n\t\t\tqueue.push(self);\n\t\t\tprocessQueue();\n\n\t\t\treturn deferred.pledge;\n\t\t}\n\n\t\tTask.prototype = {\n\t\t\t/* only for reference\n\t\t\tdeferred:  null,\n\t\t\tload:      null,\n\t\t\tparameter: null,\n\t\t\t*/\n\t\t\tonMessage: function(event) {\n\t\t\t\tvar self = this;\n\n\t\t\t\tif(event.data.type === 'result') {\n\t\t\t\t\tself.deferred.resolve(event.data.result);\n\t\t\t\t\tdisposeTask(self);\n\t\t\t\t}\n\t\t\t},\n\t\t\tonError: function() {\n\t\t\t\tvar self = this;\n\n\t\t\t\tself.deferred.reject();\n\t\t\t\tdisposeTask(self);\n\t\t\t}\n\t\t};\n\n\t\tif(supported) {\n\t\t\ttry {\n\t\t\t\tworker = NativeUrl.createObjectURL(new NativeBlob([ source ], { type: 'application/javascript' }));\n\n\t\t\t\tfor(; i < 4; i++) {\n\t\t\t\t\tthreads.idle[i] = new NativeWorker(worker);\n\t\t\t\t}\n\t\t\t} catch(exception) {\n\t\t\t\tsupported = false;\n\t\t\t}\n\t\t}\n\n\t\treturn Task.extends(abstractUuid);\n\t}\n\n\tprovide([ '/demand/abstract/uuid', '/demand/pledge', '/demand/validator/isInstanceOf', '/demand/function/defer', './support/method' ],definition);\n}(this));"]}